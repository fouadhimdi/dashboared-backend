import React, { useState, useEffect, useCallback } from 'react';
import * as XLSX from 'xlsx';
import Sidebar from '../components/layout/Sidebar';
import TimeComparisonChart from '../components/charts/TimeComparisonChart';
import ComparativeBarChart from '../components/charts/ComparativeBarChart';
import { excelAnalyticsService } from '../services/excelAnalyticsService';

const RAD = () => {
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState('');
  const [tableData, setTableData] = useState({ headers: [], rows: [] });
  const [excelFiles, setExcelFiles] = useState([]);
  const [selectedFile, setSelectedFile] = useState('');
  const [kpiValues, setKpiValues] = useState({
    'reportTurnaroundTime': '-',
    'radRetakeRate': '-',
    'radExamCompletionTime': '-',
    'radUtilization': '-',
    'patientWaitingTime': '-',
    'criticalResultsReporting': '-',
    'correctPatientID': '-',
    'techCallbackTime': '-',
    'schedulingAccuracy': '-'
  });
  
  // ุจูุงูุงุช ูุคุดุฑุงุช ุงูุฃุฏุงุก ุงูุฑุฆูุณูุฉ ุนุจุฑ ุงูุฒูู
  const [timeSeriesData, setTimeSeriesData] = useState({
    inpatientWaitTime: { labels: [], data: [], metadata: {} },
    opdWaitTime: { labels: [], data: [], metadata: {} },
    machineUtilization: { labels: [], data: [], metadata: {} }
  });
  
  // ุจูุงูุงุช ุงูููุงุฑูุฉ ุจูู ุงููุฆุงุช
  const [comparativeData, setComparativeData] = useState({
    machineUtilization: { labels: [], data: [], metadata: {} },
    scansByType: { labels: [], data: [], metadata: {} }
  });
  
  // ุญุงูุฉ ุชุญููู ุงูุฑุณูู ุงูุจูุงููุฉ
  const [chartsLoading, setChartsLoading] = useState(false);
  
  // ุชุนุฑูู ุนูุงุตุฑ ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ
  const menuItems = [
    { id: 'admin', label: 'ููุญุฉ ุงูุชุญูู', icon: '๐จโ๐ผ', path: '/admin' },
    { id: 'emergency', label: 'ูุณู ุงูุทูุงุฑุฆ', icon: '๐ฅ', path: '/emergency', showForRegularUser: true },
    { id: 'operations', label: 'ูุณู ุงูุนูููุงุช', icon: '๐ช', path: '/operations', showForRegularUser: true },
    { id: 'lab', label: 'ูุณู ุงููุฎุชุจุฑ', icon: '๐งช', path: '/lab', showForRegularUser: true },
    { id: 'bloodbank', label: 'ุจูู ุงูุฏู', icon: '๐ฉธ', path: '/bloodbank', showForRegularUser: true },
    { id: 'rad', label: 'ูุณู ุงูุฃุดุนุฉ', icon: '๐ก', path: '/rad', showForRegularUser: true },
  ];
  
  // ุชุนุฑูู ูุคุดุฑุงุช ุงูุฃุฏุงุก ุงูุฑุฆูุณูุฉ ูุน ุชูุงุตูู ุงูุฎูุงูุง ุงููุญุฏุฏุฉ - ุชู ุชุญุฏูุซ ุงูููุงูุน ูุชุชุทุงุจู ูุน ุงูุงูุณู
  const kpiDefinitions = [
    {
      id: 'reportTurnaroundTime',
      title: 'ุฒูู ุงูุชุธุงุฑ ุงููููููู',
      englishTitle: 'KPI 1: Order to Scan Time (Inpatient)',
      targetText: 'ุฃูู ูู 24 ุณุงุนุฉ',
      borderColor: 'indigo',
      // ุชุญุฏูุซ ููุฑุงุกุฉ ูููุฉ CT ูููููููู ูู ุนููุฏ P ุตู 3
      exactCell: { sheetName: 'KPIs 1-3 - manual', rowIndex: 2, columnName: 'P' }
    },
    {
      id: 'radRetakeRate',
      title: 'ููุช ุงููุญุต ุฅูู ุงูุชูุฑูุฑ (ุงููููููู)',
      englishTitle: 'KPI 2: Scan to Release Time (Inpatient)',
      targetText: 'ุฃูู ูู 5 ุณุงุนุงุช',
      borderColor: 'blue',
      // ุชุญุฏูุซ ููุฑุงุกุฉ ูููุฉ CT ูููููููู ูู ุนููุฏ Q ุตู 3
      exactCell: { sheetName: 'KPIs 1-3 - manual', rowIndex: 2, columnName: 'Q' }
    },
    {
      id: 'radExamCompletionTime',
      title: 'ุฒูู ุงูุชุธุงุฑ ุงูุนูุงุฏุงุช',
      englishTitle: 'KPI 1: Order to Scan Time (OPD)',
      targetText: 'ุฃูู ูู 24 ุณุงุนุฉ',
      borderColor: 'blue',
      // ุชุญุฏูุซ ููุฑุงุกุฉ ูููุฉ CT ููุนูุงุฏุงุช ูู ุนููุฏ R ุตู 3
      exactCell: { sheetName: 'KPIs 1-3 - manual', rowIndex: 2, columnName: 'R' }
    },
    {
      id: 'patientWaitingTime',
      title: 'ููุช ุงููุญุต ุฅูู ุงูุชูุฑูุฑ (ุงูุนูุงุฏุงุช)',
      englishTitle: 'KPI 2: Scan to Release Time (OPD)',
      targetText: 'ุฃูู ูู 5 ุณุงุนุงุช',
      borderColor: 'purple',
      // ุชุญุฏูุซ ููุฑุงุกุฉ ูููุฉ CT ููุนูุงุฏุงุช ูู ุนููุฏ S ุตู 3
      exactCell: { sheetName: 'KPIs 1-3 - manual', rowIndex: 2, columnName: 'S' }
    },
    {
      id: 'radUtilization',
      title: 'ูุนุฏู ุงุณุชุฎุฏุงู CT',
      englishTitle: 'KPI 3: Machine Utilization (CT)',
      targetText: 'ุฃูุซุฑ ูู 80%',
      borderColor: 'green',
      // ุชุญุฏูุซ ููุฑุงุกุฉ ูุนุฏู ุงุณุชุฎุฏุงู CT ูู ุนููุฏ T ุตู 3
      exactCell: { sheetName: 'KPIs 1-3 - manual', rowIndex: 2, columnName: 'T' }
    },
    {
      id: 'criticalResultsReporting',
      title: 'ูุนุฏู ุงุณุชุฎุฏุงู MRI',
      englishTitle: 'KPI 3: Machine Utilization (MRI)',
      targetText: 'ุฃูุซุฑ ูู 80%',
      borderColor: 'purple',
      // ุชุญุฏูุซ ููุฑุงุกุฉ ูุนุฏู ุงุณุชุฎุฏุงู MRI ูู ุนููุฏ T ุตู 4
      exactCell: { sheetName: 'KPIs 1-3 - manual', rowIndex: 3, columnName: 'T' }
    },
    {
      id: 'schedulingAccuracy',
      title: 'ูุนุฏู ุงุณุชุฎุฏุงู Ultrasound',
      englishTitle: 'KPI 3: Machine Utilization (Ultrasound)',
      targetText: 'ุฃูุซุฑ ูู 80%',
      borderColor: 'yellow',
      // ุชุญุฏูุซ ููุฑุงุกุฉ ูุนุฏู ุงุณุชุฎุฏุงู Ultrasound ูู ุนููุฏ T ุตู 5
      exactCell: { sheetName: 'KPIs 1-3 - manual', rowIndex: 4, columnName: 'T' }
    }
  ];
  
  // ุงูุจูุด ูุงุฑู ููู ูุคุดุฑ (ูุคุดุฑุงุช ูุณู ุงูุฃุดุนุฉ)
  const benchmarks = {
    // 1. Order to Scan Time (ุณุงุนุงุช)
    "KPI 1: Order to Scan Time": {
      worldClass: { max: 24, color: "#0072C6" }, // ุฃูู ูู 24 ุณุงุนุฉ
      acceptable: { min: 24, max: 36, color: "#00B050" }, // 24-36 ุณุงุนุฉ
      needsImprovement: { min: 36, max: 48, color: "#FFC000" }, // 36-48 ุณุงุนุฉ
      unacceptable: { min: 48, color: "#C00000" } // ุฃูุซุฑ ูู 48 ุณุงุนุฉ
    },
    
    // 2. Scan to Release Time
    "KPI 2: Scan to Release Time": {
      worldClass: { max: 5, color: "#0072C6" }, // ุฃูู ูู 5 ุณุงุนุงุช
      acceptable: { min: 5, max: 7, color: "#00B050" }, // 5-7 ุณุงุนุงุช
      needsImprovement: { min: 7, max: 10, color: "#FFC000" }, // 7-10 ุณุงุนุงุช
      unacceptable: { min: 10, color: "#C00000" } // ุฃูุซุฑ ูู 10 ุณุงุนุงุช
    },
    
    // 3. Machine Utilization by modality
    "KPI 3: Machine Utilization by modality": {
      worldClass: { min: 80, color: "#0072C6" }, // ุฃูุซุฑ ูู 80%
      acceptable: { min: 70, max: 80, color: "#00B050" }, // 70%-80%
      needsImprovement: { min: 60, max: 70, color: "#FFC000" }, // 60%-70%
      unacceptable: { max: 60, color: "#C00000" } // ุฃูู ูู 60%
    }
  };
  
  // ุฏุงูุฉ ูุชูุณูู ูููุฉ ุงููุคุดุฑ - ุชู ุชุญุฏูุซูุง ููุนุงูุฌุฉ ุงูููู ุจุดูู ุตุญูุญ ูุนุฑุถูุง ุจููุณ ุงูุชูุณูู ูู ุงูุงูุณู
  const formatKpiValue = (value, kpiId) => {
    if (value === null || value === undefined) {
      return '-';
    }
    
    // ุชูุณูู ุฎุงุต ููู ูุคุดุฑ
    if (kpiId === 'radUtilization' || kpiId === 'criticalResultsReporting' || kpiId === 'schedulingAccuracy') {
      // ููู ูุณุจุฉ ุงุณุชุฎุฏุงู ุงูุฃุฌูุฒุฉ ุชุนุฑุถ ููุณุจุฉ ูุฆููุฉ
      // ุงูุชุญูู ูู ููู ุงููููุฉ ูุตูุฉ ูุชุญุชูู ุจุงููุนู ุนูู ุนูุงูุฉ ุงููุณุจุฉ ุงููุฆููุฉ
      if (typeof value === 'string' && value.includes('%')) {
        // ุชูุตูุฑ ุงููุณุจุฉ ุงููุฆููุฉ ุฅูู ุฑูููู ุจุนุฏ ุงููุงุตูุฉ
        const numValue = parseFloat(value);
        if (!isNaN(numValue)) {
          return `${numValue.toFixed(2)}%`;
        }
        return value;
      }
      
      // ุชุญููู ุงููููุฉ ุฅูู ุฑูู
      const numValue = parseFloat(value);
      if (isNaN(numValue)) {
        return value.toString();
      }
      
      // ุนุฑุถ ุงููุณุจุฉ ุงููุฆููุฉ ุจุฑูููู ุนุดุฑููู ููุท
      return `${numValue.toFixed(2)}%`;
    } else {
      // ุชูุณูู ุงูููู ุงูุฒูููุฉ ุจุตูุบุฉ ุณุงุนุฉ:ุฏูููุฉ
      // ุงูุชุญูู ูู ููู ุงููููุฉ ูุตูุฉ ูุชุญุชูู ุจุงููุนู ุนูู ุชูุณูู ุงูููุช
      if (typeof value === 'string' && value.includes(':')) {
        return value;
      }
      
      // ุชุญููู ุงููููุฉ ุฅูู ุฑูู
      const numValue = parseFloat(value);
      if (isNaN(numValue)) {
        return value.toString();
      }
      
      // ุชุญููู ุงูุณุงุนุงุช ุงูุนุดุฑูุฉ ุฅูู ุชูุณูู ุณุงุนุฉ:ุฏูููุฉ
      const hours = Math.floor(numValue);
      const minutes = Math.round((numValue - hours) * 60);
      return `${hours}:${minutes.toString().padStart(2, '0')}`;
    }
  };

  // ุฏุงูุฉ ููุฑุงุกุฉ ูููุฉ ูู ุฎููุฉ ูุญุฏุฏุฉ ูู ูุฑูุฉ ุงูุนูู - ุชู ุชุญุณูููุง ููุชุนุงูู ูุน ููู ุงูููุช
  const getValueByExactCell = (workbook, exactCell) => {
    // ุงูุชุญูู ูู ูุฌูุฏ ุงุณู ูุฑูุฉ ุงูุนูู
    if (!exactCell || !exactCell.sheetName || !workbook.Sheets[exactCell.sheetName]) {
      console.warn('ูู ูุชู ุชุญุฏูุฏ ูุฑูุฉ ุงูุนูู ุฃู ุงููุฑูุฉ ุบูุฑ ููุฌูุฏุฉ', exactCell);
      return null;
    }

    // ุงูุญุตูู ุนูู ูุฑูุฉ ุงูุนูู
    const sheet = workbook.Sheets[exactCell.sheetName];
    
    // ุชุญููู ุงูุนููุฏ ุฅูู ุฑูู ููุงุณุชุฎุฏุงู ูู XLSX
    const cellAddress = exactCell.columnName + (exactCell.rowIndex + 1);
    console.log(`ุงูุจุญุซ ุนู ุงููููุฉ ูู ุงูุฎููุฉ: ${cellAddress} ูู ูุฑูุฉ ${exactCell.sheetName}`);
    
    // ุงูุญุตูู ุนูู ูููุฉ ุงูุฎููุฉ
    const cell = sheet[cellAddress];
    
    // ุทุจุงุนุฉ ูููุฉ ุงูุฎููุฉ ููุชุตุญูุญ
    if (cell) {
      console.log(`ูููุฉ ุงูุฎููุฉ ${cellAddress}: `, cell.v);
      
      // ูุนุงูุฌุฉ ุฎุงุตุฉ ููููู ุงูุฒูููุฉ ุงูุชู ุชุฎุฒู ูู ุงูุณู ูุฃุฑูุงู ุฃู ูุชูุงุฑูุฎ
      if (exactCell.columnName !== 'T') {
        if (cell.t === 'n') {
          // Excel ูุฎุฒู ุงูููุช ูุฌุฒุก ูู ุงูููู
          const totalHours = cell.v * 24;
          const hours = Math.floor(totalHours);
          const minutes = Math.round((totalHours - hours) * 60);
          return `${hours}:${minutes.toString().padStart(2, '0')}`;
        } else if (cell.v instanceof Date) {
          // ุฅุฐุง ูุงูุช ุงููููุฉ ุชุงุฑูุฎ
          const hours = cell.v.getHours();
          const minutes = cell.v.getMinutes();
          return `${hours}:${minutes.toString().padStart(2, '0')}`;
        }
      } else if (exactCell.columnName === 'T') {
        // ููุฃุนูุฏุฉ ุงูุชู ุชุญุชูู ุนูู ูุณุจ ูุฆููุฉุ ูู ุจุชุญููููุง ูุจุงุดุฑุฉ ุฅูู ูุณุจุฉ ูุฆููุฉ
        return cell.v * 100;
      }
      
      return cell.v;
    } else {
      console.warn(`ุงูุฎููุฉ ${cellAddress} ุบูุฑ ููุฌูุฏุฉ ูู ูุฑูุฉ ${exactCell.sheetName}`);
    }
    
    return null;
  };
  
  // ุฏุงูุฉ ูุชุญุฏูุฏ ุงูููู ุงูููุงุณุจ ูููููุฉ ุจูุงุกู ุนูู ุงูุจูุด ูุงุฑู
  const getColorForValue = (kpiName, value) => {
    if (value === '' || value === 'NA' || value === null || value === undefined || value === '-') {
      return ''; // ูุง ููู
    }
    
    // ุงูุจุญุซ ุนู ุงูุจูุด ูุงุฑู ุงูููุงุณุจ
    const benchmark = benchmarks[kpiName];
    
    // ุฅุฐุง ูู ูุชู ุงูุนุซูุฑ ุนูู ุจูุด ูุงุฑู ููุฐุง ุงููุคุดุฑ
    if (!benchmark) {
      return '';
    }
    
    // ุงุณุชุฎุฑุงุฌ ุงููููุฉ ุงูุฑูููุฉ
    let numericValue;
    
    if (typeof value === 'string') {
      if (value.includes('%')) {
        numericValue = parseFloat(value);
      } else if (value.includes(':')) {
        // ุชุญููู ููุช ุจุตูุบุฉ "ุณุงุนุฉ:ุฏูููุฉ" ุฅูู ุณุงุนุงุช ุนุดุฑูุฉ
        const [hours, minutes] = value.split(':').map(Number);
        numericValue = hours + (minutes / 60);
      } else {
        numericValue = parseFloat(value);
      }
    } else {
      numericValue = value;
    }
    
    if (isNaN(numericValue)) {
      return '';
    }
    
    // ุงูุชุญูู ูู ูุทุงู ุงูููู
    if (benchmark.worldClass) {
      if ((benchmark.worldClass.min !== undefined && numericValue >= benchmark.worldClass.min) &&
          (benchmark.worldClass.max !== undefined && numericValue <= benchmark.worldClass.max)) {
        return benchmark.worldClass.color;
      } else if (benchmark.worldClass.min !== undefined && benchmark.worldClass.max === undefined && numericValue >= benchmark.worldClass.min) {
        return benchmark.worldClass.color;
      } else if (benchmark.worldClass.max !== undefined && benchmark.worldClass.min === undefined && numericValue <= benchmark.worldClass.max) {
        return benchmark.worldClass.color;
      }
    }
    
    if (benchmark.acceptable) {
      if ((benchmark.acceptable.min !== undefined && numericValue >= benchmark.acceptable.min) &&
          (benchmark.acceptable.max !== undefined && numericValue <= benchmark.acceptable.max)) {
        return benchmark.acceptable.color;
      } else if (benchmark.acceptable.min !== undefined && benchmark.acceptable.max === undefined && numericValue >= benchmark.acceptable.min) {
        return benchmark.acceptable.color;
      } else if (benchmark.acceptable.max !== undefined && benchmark.acceptable.min === undefined && numericValue <= benchmark.acceptable.max) {
        return benchmark.acceptable.color;
      }
    }
    
    if (benchmark.needsImprovement) {
      if ((benchmark.needsImprovement.min !== undefined && numericValue >= benchmark.needsImprovement.min) &&
          (benchmark.needsImprovement.max !== undefined && numericValue <= benchmark.needsImprovement.max)) {
        return benchmark.needsImprovement.color;
      } else if (benchmark.needsImprovement.min !== undefined && benchmark.needsImprovement.max === undefined && numericValue >= benchmark.needsImprovement.min) {
        return benchmark.needsImprovement.color;
      } else if (benchmark.needsImprovement.max !== undefined && benchmark.needsImprovement.min === undefined && numericValue <= benchmark.needsImprovement.max) {
        return benchmark.needsImprovement.color;
      }
    }
    
    if (benchmark.unacceptable) {
      if ((benchmark.unacceptable.min !== undefined && numericValue >= benchmark.unacceptable.min) &&
          (benchmark.unacceptable.max !== undefined && numericValue <= benchmark.unacceptable.max)) {
        return benchmark.unacceptable.color;
      } else if (benchmark.unacceptable.min !== undefined && benchmark.unacceptable.max === undefined && numericValue >= benchmark.unacceptable.min) {
        return benchmark.unacceptable.color;
      } else if (benchmark.unacceptable.max !== undefined && benchmark.unacceptable.min === undefined && numericValue <= benchmark.unacceptable.max) {
        return benchmark.unacceptable.color;
      }
    }
    
    return ''; // ููู ุงูุชุฑุงุถู ุฅุฐุง ูู ุชุชุทุงุจู ุฃู ุญุงูุฉ
  };

  // ูุธุงุฆู ุฅุถุงููุฉ ูููุณุงุนุฏุฉ ูู ุงูุฌูุงู
  const getBenchmarkLabel = (kpiName, value) => {
    if (value === '' || value === 'NA' || value === null || value === undefined || value === '-') {
      return ''; 
    }
    
    const benchmark = benchmarks[kpiName];
    if (!benchmark) return '';
    
    let numericValue;
    
    if (typeof value === 'string') {
      if (value.includes('%')) {
        numericValue = parseFloat(value);
      } else if (value.includes(':')) {
        // ุชุญููู ููุช ุจุตูุบุฉ "ุณุงุนุฉ:ุฏูููุฉ" ุฅูู ุณุงุนุงุช ุนุดุฑูุฉ
        const [hours, minutes] = value.split(':').map(Number);
        numericValue = hours + (minutes / 60);
      } else {
        numericValue = parseFloat(value);
      }
    } else {
      numericValue = value;
    }
    
    if (isNaN(numericValue)) {
      return '';
    }
    
    if (benchmark.worldClass) {
      if ((benchmark.worldClass.min !== undefined && numericValue >= benchmark.worldClass.min) &&
          (benchmark.worldClass.max !== undefined && numericValue <= benchmark.worldClass.max)) {
        return 'ููุชุงุฒ';
      } else if (benchmark.worldClass.min !== undefined && benchmark.worldClass.max === undefined && numericValue >= benchmark.worldClass.min) {
        return 'ููุชุงุฒ';
      } else if (benchmark.worldClass.max !== undefined && benchmark.worldClass.min === undefined && numericValue <= benchmark.worldClass.max) {
        return 'ููุชุงุฒ';
      }
    }
    
    if (benchmark.acceptable) {
      if ((benchmark.acceptable.min !== undefined && numericValue >= benchmark.acceptable.min) &&
          (benchmark.acceptable.max !== undefined && numericValue <= benchmark.acceptable.max)) {
        return 'ุฌูุฏ';
      } else if (benchmark.acceptable.min !== undefined && benchmark.acceptable.max === undefined && numericValue >= benchmark.acceptable.min) {
        return 'ุฌูุฏ';
      } else if (benchmark.acceptable.max !== undefined && benchmark.acceptable.min === undefined && numericValue <= benchmark.acceptable.max) {
        return 'ุฌูุฏ';
      }
    }
    
    if (benchmark.needsImprovement) {
      if ((benchmark.needsImprovement.min !== undefined && numericValue >= benchmark.needsImprovement.min) &&
          (benchmark.needsImprovement.max !== undefined && numericValue <= benchmark.needsImprovement.max)) {
        return 'ูุญุชุงุฌ ุชุญุณูู';
      } else if (benchmark.needsImprovement.min !== undefined && benchmark.needsImprovement.max === undefined && numericValue >= benchmark.needsImprovement.min) {
        return 'ูุญุชุงุฌ ุชุญุณูู';
      } else if (benchmark.needsImprovement.max !== undefined && benchmark.needsImprovement.min === undefined && numericValue <= benchmark.needsImprovement.max) {
        return 'ูุญุชุงุฌ ุชุญุณูู';
      }
    }
    
    if (benchmark.unacceptable) {
      if ((benchmark.unacceptable.min !== undefined && numericValue >= benchmark.unacceptable.min) &&
          (benchmark.unacceptable.max !== undefined && numericValue <= benchmark.unacceptable.max)) {
        return 'ุบูุฑ ููุจูู';
      } else if (benchmark.unacceptable.min !== undefined && benchmark.unacceptable.max === undefined && numericValue >= benchmark.unacceptable.min) {
        return 'ุบูุฑ ููุจูู';
      } else if (benchmark.unacceptable.max !== undefined && benchmark.unacceptable.min === undefined && numericValue <= benchmark.unacceptable.max) {
        return 'ุบูุฑ ููุจูู';
      }
    }
    
    return '';
  };
  
  // ุฏุงูุฉ ูุงุณุชุฎุฑุงุฌ ูุคุดุฑุงุช ุงูุฃุฏุงุก ูู ูุฑูุฉ ุงูุนูู ุงููุญุฏุฏุฉ - ุชู ุชุญุฏูุซูุง
  const extractKpisFromWorkbook = (workbook) => {
    let extractedKpis = {
      'reportTurnaroundTime': '-',
      'radRetakeRate': '-',
      'radExamCompletionTime': '-',
      'radUtilization': '-',
      'patientWaitingTime': '-',
      'criticalResultsReporting': '-',
      'correctPatientID': '-',
      'techCallbackTime': '-',
      'schedulingAccuracy': '-'
    };
    
    // ุงุณุชุฎุฑุงุฌ ููู ุงููุคุดุฑุงุช ูู ุงูุฎูุงูุง ุงููุญุฏุฏุฉ
    for (const kpiDef of kpiDefinitions) {
      if (kpiDef.exactCell) {
        const value = getValueByExactCell(workbook, kpiDef.exactCell);
        
        if (value !== null) {
          extractedKpis[kpiDef.id] = value;
        } else {
          console.warn(`ูู ูุชู ุงูุนุซูุฑ ุนูู ูููุฉ ูููุคุดุฑ ${kpiDef.id} ูู ุงูุฎููุฉ ุงููุญุฏุฏุฉ`);
          // ูุจูู ุนูู ุงูููู ุงูุงูุชุฑุงุถูุฉ '-' ุฅุฐุง ูู ูุชููู ูู ูุฑุงุกุฉ ุงููููุฉ
        }
      }
    }
    
    return extractedKpis;
  };
  
  // ุฏุงูุฉ ูุชุญููู ูููุงุช Excel ุงููุชุงุญุฉ
  const loadExcelFiles = async () => {
    try {
      // ูู ุงูุฅูุชุงุฌุ ูุฌุจ ุงุณุชุฎุฏุงู API ูุฌูุจ ูุงุฆูุฉ ุงููููุงุช
      // ููุง ููุชุฑุถ ุฃููุง ูุนุฑู ุฃุณูุงุก ุงููููุงุช ูุณุจููุง ูู ูููู ุงููุฌูุฏ
      const files = [
        'RAD-JD-GEN-4-2025-FEB.xlsx',
        'RAD-JD-GEN-4-2025-MAR.xlsx'
      ];
      
      setExcelFiles(files);
      
      // ุงุฎุชูุงุฑ ุฃุญุฏุซ ููู ุงูุชุฑุงุถููุง
      if (files.length > 0) {
        setSelectedFile(files[files.length - 1]);
        await loadExcelData(files[files.length - 1]);
      } else {
        setError('ูุง ุชูุฌุฏ ูููุงุช ุจูุงูุงุช ูุชุงุญุฉ');
        setLoading(false);
      }
    } catch (err) {
      console.error('Error loading Excel files:', err);
      setError('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญููู ูููุงุช ุงูุจูุงูุงุช');
      setLoading(false);
    }
  };
  
  // ุฏุงูุฉ ูุชุญููู ุจูุงูุงุช ููู Excel ุงููุญุฏุฏ - ุชู ุชุญุฏูุซูุง
  const loadExcelData = async (filePath) => {
    try {
      setLoading(true);
      
      const response = await fetch(`/data/RAD/${filePath}`);
      const data = await response.arrayBuffer();
      
      // ุชุญุณูู ูุฑุงุกุฉ ููู Excel ุจุฅุถุงูุฉ ุฎูุงุฑุงุช ุฅุถุงููุฉ
      const workbook = XLSX.read(data, { 
        type: 'array',
        cellStyles: true,
        cellDates: true,
        cellNF: true,
        cellFormula: true
      });
      
      console.log('ุชู ุชุญููู ููู Excel:', workbook.SheetNames);
      
      // ุงุณุชุฎุฑุงุฌ ูุคุดุฑุงุช ุงูุฃุฏุงุก ูุจุงุดุฑุฉ ูู ุงูููู
      const kpis = extractKpisFromWorkbook(workbook);
      setKpiValues(kpis);
      
      // ุฌูุน ุงูุจูุงูุงุช ููุฌุฏูู (ุงุฎุชูุงุฑู)
      // ุงุณุชุฎุฏุงู ุฃูู ูุฑูุฉ ุนูู ุฅุฐุง ูู ูุชู ุชุญุฏูุฏ ูุงุญุฏุฉ ูุญุฏุฏุฉ
      const firstSheetName = workbook.SheetNames[0];
      const sheet = workbook.Sheets[firstSheetName];
      
      if (sheet) {
        const sheetData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
        const headers = sheetData[0] || [];
        const rows = sheetData.slice(1);
        setTableData({ headers, rows });
      }
      
      setLoading(false);
    } catch (err) {
      console.error('Error loading Excel data:', err);
      setError('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญููู ุจูุงูุงุช ุงูููู');
      setLoading(false);
    }
  };
  
  // ูุนุงูุฌ ุชุบููุฑ ุงูููู ุงููุญุฏุฏ
  const handleFileChange = async (e) => {
    const filePath = e.target.value;
    setSelectedFile(filePath);
    await loadExcelData(filePath);
  };
  
  // ุงุณุชุฎุฑุงุฌ ุชุงุฑูุฎ ุงูููู ุงููุญุฏุฏ
  const getSelectedFileDate = useCallback(() => {
    if (!selectedFile) return '';
    
    const dateMatch = selectedFile.match(/(\d{4})-([A-Z]{3})/);
    if (dateMatch) {
      const months = {
        'JAN': 'ููุงูุฑ', 'FEB': 'ูุจุฑุงูุฑ', 'MAR': 'ูุงุฑุณ', 'APR': 'ุฃุจุฑูู',
        'MAY': 'ูุงูู', 'JUN': 'ููููู', 'JUL': 'ููููู', 'AUG': 'ุฃุบุณุทุณ',
        'SEP': 'ุณุจุชูุจุฑ', 'OCT': 'ุฃูุชูุจุฑ', 'NOV': 'ููููุจุฑ', 'DEC': 'ุฏูุณูุจุฑ'
      };
      return `${months[dateMatch[2]]} ${dateMatch[1]}`;
    }
    return '';
  }, [selectedFile]);
  
  // useEffect hook to load Excel files
  useEffect(() => {
    loadExcelFiles();
  }, []);
  
  // ูุธููุฉ ููุฑุงุกุฉ ุจูุงูุงุช ุงูุฑุณูู ุงูุจูุงููุฉ ูู ูุฌููุนุฉ ุงููููุงุช
  useEffect(() => {
    const loadHistoricalData = async () => {
      if (!excelFiles || excelFiles.length === 0) {
        return;
      }

      try {
        setChartsLoading(true);
        
        // ุชุญุถูุฑ ูุณุงุฑุงุช ุงููููุงุช
        const filePaths = excelFiles.map(file => `RAD/${file}`);
        
        // ุงุณุชุฎุฏุงู placeholderData ูุคูุชูุง ุญุชู ูุชู ุชุตุญูุญ ูุดููุฉ ุนุฏู ูุฌูุฏ ุงููุฑูุฉ ูู ูููุงุช Excel
        const placeholderData = excelAnalyticsService.generatePlaceholderData(6, 10, 36);
        const utilizationPlaceholderData = excelAnalyticsService.generatePlaceholderData(6, 60, 98);
        
        // ูุญุงููุฉ ูุฑุงุกุฉ ุงูุจูุงูุงุช ูู ุงููููุงุชุ ูุน ุงุณุชุฎุฏุงู ุงูุจูุงูุงุช ุงูุงุญุชูุงุทูุฉ ูู ุญุงูุฉ ุงูุฎุทุฃ
        try {
          // ุงุณุชุฎุฑุงุฌ ุจูุงูุงุช ููุช ุงูุงูุชุธุงุฑ ูููููููู ุนุจุฑ ุงูุฒูู (KPI 1)
          const inpatientWaitTimeData = await excelAnalyticsService.extractTimeSeriesData(
            filePaths,
            'KPIs', // ุชุนุฏูู ุงุณู ุงููุฑูุฉ ููููู ุฃูุซุฑ ูุฑููุฉ
            'P', 
            2, 
            excelAnalyticsService.transformers.timeInMinutes
          );
          
          // ุงูุชุญูู ูู ูุฌูุฏ ุจูุงูุงุช ูุนููุฉ
          setTimeSeriesData(prev => ({
            ...prev,
            inpatientWaitTime: inpatientWaitTimeData.data.length > 0 ? inpatientWaitTimeData : placeholderData
          }));
        } catch (err) {
          console.log("ุงุณุชุฎุฏุงู ุจูุงูุงุช ุงุญุชูุงุทูุฉ ูููุช ุงูุชุธุงุฑ ุงููููููู:", err);
          setTimeSeriesData(prev => ({
            ...prev,
            inpatientWaitTime: placeholderData
          }));
        }
        
        try {
          // ุงุณุชุฎุฑุงุฌ ุจูุงูุงุช ููุช ุงูุงูุชุธุงุฑ ููุนูุงุฏุงุช ุงูุฎุงุฑุฌูุฉ ุนุจุฑ ุงูุฒูู (KPI 1)
          const opdWaitTimeData = await excelAnalyticsService.extractTimeSeriesData(
            filePaths,
            'KPIs', 
            'R', 
            2, 
            excelAnalyticsService.transformers.timeInMinutes
          );
          
          setTimeSeriesData(prev => ({
            ...prev,
            opdWaitTime: opdWaitTimeData.data.length > 0 ? opdWaitTimeData : placeholderData
          }));
        } catch (err) {
          console.log("ุงุณุชุฎุฏุงู ุจูุงูุงุช ุงุญุชูุงุทูุฉ ูููุช ุงูุชุธุงุฑ ุงูุนูุงุฏุงุช:", err);
          setTimeSeriesData(prev => ({
            ...prev,
            opdWaitTime: placeholderData
          }));
        }
        
        try {
          // ุงุณุชุฎุฑุงุฌ ุจูุงูุงุช ูุนุฏู ุงุณุชุฎุฏุงู ุงูุฃุฌูุฒุฉ ุนุจุฑ ุงูุฒูู (KPI 3)
          const machineUtilizationData = await excelAnalyticsService.extractTimeSeriesData(
            filePaths,
            'KPIs', 
            'T', 
            2, 
            excelAnalyticsService.transformers.percentage
          );
          
          setTimeSeriesData(prev => ({
            ...prev,
            machineUtilization: machineUtilizationData.data.length > 0 ? machineUtilizationData : utilizationPlaceholderData
          }));
        } catch (err) {
          console.log("ุงุณุชุฎุฏุงู ุจูุงูุงุช ุงุญุชูุงุทูุฉ ููุนุฏู ุงุณุชุฎุฏุงู ุงูุฃุฌูุฒุฉ:", err);
          setTimeSeriesData(prev => ({
            ...prev,
            machineUtilization: utilizationPlaceholderData
          }));
        }
        
        // ุงุณุชุฎุฑุงุฌ ุจูุงูุงุช ุงูููุงุฑูุฉ ููุนุฏูุงุช ุงุณุชุฎุฏุงู ุงูุฃุฌูุฒุฉ
        const machineTypes = ['CT', 'MRI', 'Ultrasound'];
        const utilizationValues = [
          kpiValues.radUtilization ? parseFloat(kpiValues.radUtilization) : 86.3,
          kpiValues.criticalResultsReporting ? parseFloat(kpiValues.criticalResultsReporting) : 64.3,
          kpiValues.schedulingAccuracy ? parseFloat(kpiValues.schedulingAccuracy) : 85.8
        ];
        
        // ุจูุงูุงุช ููุงุฑูุฉ ูุนุฏูุงุช ุงุณุชุฎุฏุงู ุงูุฃุฌูุฒุฉ - ูู ุงูุจูุงูุงุช ุงูุญุงููุฉ
        const utilizationData = {
          labels: machineTypes,
          data: utilizationValues,
          metadata: {
            min: Math.min(...utilizationValues.filter(v => !isNaN(v))),
            max: Math.max(...utilizationValues.filter(v => !isNaN(v))),
            avg: utilizationValues.filter(v => !isNaN(v)).reduce((sum, val) => sum + val, 0) / 
                 utilizationValues.filter(v => !isNaN(v)).length
          }
        };
        
        // ุงุณุชุฎุฑุงุฌ ุจูุงูุงุช ุฃููุงุน ุงููุญูุตุงุช (ุจูุงูุงุช ุงูุชุฑุงุถูุฉ)
        const scanTypesData = {
          labels: ['X-Ray', 'CT', 'MRI', 'Ultrasound', 'Interventional'],
          data: [45, 25, 15, 10, 5], // ููู ุงูุชุฑุงุถูุฉ
          metadata: {
            total: 100,
            min: 5,
            max: 45,
            avg: 20
          }
        };
        
        setComparativeData({
          machineUtilization: utilizationData,
          scansByType: scanTypesData
        });
      } catch (err) {
        console.error('Error loading historical data:', err);
      } finally {
        setChartsLoading(false);
      }
    };
    
    loadHistoricalData();
  }, [excelFiles, selectedFile, kpiValues]);
  
  // ูููู KpiCard ูููุคุดุฑ ุงููุงุญุฏ
  const KpiCard = ({ kpiDef }) => {
    // ุชุญุฏูุฏ ููุน ุงููุคุดุฑ (KPI 1, KPI 2, KPI 3) ุจูุงุกู ุนูู ุนููุงู ุงููุคุดุฑ
    let kpiType = "";
    if (kpiDef.englishTitle.includes("KPI 1")) {
      kpiType = "KPI 1: Order to Scan Time";
    } else if (kpiDef.englishTitle.includes("KPI 2")) {
      kpiType = "KPI 2: Scan to Release Time";
    } else if (kpiDef.englishTitle.includes("KPI 3")) {
      kpiType = "KPI 3: Machine Utilization by modality";
    }
    
    // ุงูุญุตูู ุนูู ุงูููู ูุงูุชูููู
    const value = kpiValues[kpiDef.id];
    const valueStr = typeof value === 'string' ? value : String(value);
    const valueWithoutPercent = valueStr.includes('%') ? valueStr.replace('%', '') : valueStr;
    
    const color = getColorForValue(kpiType, valueWithoutPercent);
    const label = getBenchmarkLabel(kpiType, valueWithoutPercent);
    
    return (
      <div className={`bg-white rounded-lg shadow-sm p-3 border-r-4 border-${kpiDef.borderColor}-500 transform transition-transform hover:scale-105 hover:shadow-md`}>
        <div className="flex justify-between">
          <div>
            <p className="text-xs font-medium text-gray-500">{kpiDef.title}</p>
            <p className="text-lg font-bold text-gray-800 mt-0.5">
              {kpiValues[kpiDef.id] !== '-' ? kpiValues[kpiDef.id] : '-'}
            </p>
          </div>
          <div className={`p-2 bg-${kpiDef.borderColor}-100 rounded-lg`}>
            <svg className={`w-6 h-6 text-${kpiDef.borderColor}-500`} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              {kpiDef.id.includes('Time') ? (
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
              ) : (
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
              )}
            </svg>
          </div>
        </div>
        <div className="mt-2 text-[10px] text-gray-500">
          ุงููุฏู ุงูุฃูุซู
          <span className={`text-${kpiDef.borderColor}-600 font-medium mr-1`}>{kpiDef.targetText}</span>
        </div>
      </div>
    );
  };
  
  // ูููู ูุนุฑุถ ูุคุดุฑ ุงูุฃุฏุงุก ุงูุชูุตููู
  const KpiDetailCard = ({ kpiDef }) => {
    // ุชุญุฏูุฏ ููุน ุงููุคุดุฑ (KPI 1, KPI 2, KPI 3) ุจูุงุกู ุนูู ุนููุงู ุงููุคุดุฑ
    let kpiType = "";
    if (kpiDef.englishTitle.includes("KPI 1")) {
      kpiType = "KPI 1: Order to Scan Time";
    } else if (kpiDef.englishTitle.includes("KPI 2")) {
      kpiType = "KPI 2: Scan to Release Time";
    } else if (kpiDef.englishTitle.includes("KPI 3")) {
      kpiType = "KPI 3: Machine Utilization by modality";
    }
    
    // ุงูุญุตูู ุนูู ุงูููู ูุงูุชูููู
    const value = kpiValues[kpiDef.id];
    const formattedValue = formatKpiValue(value, kpiDef.id);
    const valueStr = typeof formattedValue === 'string' ? formattedValue : String(formattedValue);
    const valueWithoutPercent = valueStr.includes('%') ? valueStr.replace('%', '') : valueStr;
    
    const color = getColorForValue(kpiType, valueWithoutPercent);
    const label = getBenchmarkLabel(kpiType, valueWithoutPercent);
    
    return (
      <div className="bg-gray-50 p-3 rounded-lg shadow-sm hover:shadow-md transition-shadow">
        <h3 className="text-sm font-medium text-gray-700 mb-2 border-b pb-1">{kpiDef.title}</h3>
        <div className="flex justify-between items-center">
          <div>
            <span className="text-xs text-gray-500">
              {kpiDef.id.includes('Utilization') || kpiDef.id === 'criticalResultsReporting' || kpiDef.id === 'schedulingAccuracy' ? 'ุงููุนุฏู:' : 'ุงูููุช:'}
            </span>
          </div>
          <div className="flex items-baseline">
            <span 
              className="text-xl font-bold ml-1"
              style={{ color: color || "#333" }}
            >
              {valueWithoutPercent}
            </span>
            <span className="text-xs text-gray-500">
              {kpiDef.id.includes('Utilization') || kpiDef.id === 'criticalResultsReporting' || kpiDef.id === 'schedulingAccuracy' ? '%' : 'ุณุงุนุฉ'}
            </span>
          </div>
        </div>
        <div className="mt-1 text-[10px] text-right">
          <span className="inline-block px-2 py-0.5 rounded-full" 
            style={{ 
              backgroundColor: color || "#f3f4f6",
              color: color ? "white" : "#6b7280"
            }}
          >
            {label || "ุบูุฑ ูุชููุฑ"}
          </span>
        </div>
      </div>
    );
  };
  
  return (
    <div className="min-h-screen bg-gray-50" dir="rtl">
      <div className="flex h-screen">
        {/* ุงุณุชุฎุฏุงู ูููู ุงูุดุฑูุท ุงูุฌุงูุจู ุงูููุญุฏ */}
        <Sidebar menuItems={menuItems} />

        {/* ุงููุญุชูู ุงูุฑุฆูุณู */}
        <div className="flex-1 overflow-auto bg-gray-50 mr-72">
          {/* ุฑุฃุณ ุงูุตูุญุฉ */}
          <div className="sticky top-0 z-10 bg-white shadow-sm border-b border-gray-200">
            <div className="px-4 py-2 flex justify-between items-center">
              <div>
                <h1 className="text-xl font-bold text-gray-800">ููุญุฉ ุชุญูู ุจูุงูุงุช ูุณู ุงูุฃุดุนุฉ</h1>
                {selectedFile && (
                  <div className="text-xs text-gray-500 mt-0.5">
                    {getSelectedFileDate() ? `ุจูุงูุงุช ${getSelectedFileDate()}` : selectedFile}
                  </div>
                )}
              </div>
              
              <div className="flex items-center">
                <div className="relative mr-4">
                  <div className="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                    <svg className="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                    </svg>
                  </div>
                  <select
                    value={selectedFile}
                    onChange={handleFileChange}
                    className="block w-56 bg-white border border-gray-300 rounded-lg py-1.5 pr-10 pl-3 text-sm text-gray-700 appearance-none focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all duration-200"
                  >
                    <option value="">ุงุฎุชุฑ ููู Excel</option>
                    {excelFiles.map((file, index) => (
                      <option key={index} value={file}>
                        {file}
                      </option>
                    ))}
                  </select>
                </div>
              </div>
            </div>
          </div>
          
          <div className="p-4">
            <div className="w-full mx-auto">
              {/* ุงููุณู ุงูุฑุฆูุณู - ููุฎุต ุงููุคุดุฑุงุช */}
              <div className="grid grid-cols-1 lg:grid-cols-4 gap-3 mb-4">
                {/* ุนุฑุถ ูุคุดุฑุงุช ุงูุฃุฏุงุก ุงูุฑุฆูุณูุฉ */}
                {kpiDefinitions.slice(0, 4).map((kpiDef) => (
                  <KpiCard key={kpiDef.id} kpiDef={kpiDef} />
                ))}
              </div>
              
              {loading ? (
                <div className="flex flex-col justify-center items-center h-40 bg-white rounded-lg shadow-sm">
                  <div className="w-10 h-10 border-3 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
                  <p className="text-sm text-gray-600 mt-2">ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...</p>
                </div>
              ) : error ? (
                <div className="bg-red-50 border-r-4 border-red-500 p-3 rounded-lg shadow-sm">
                  <div className="flex">
                    <div className="flex-shrink-0 mr-3">
                      <svg className="h-4 w-4 text-red-500" viewBox="0 0 20 20" fill="currentColor">
                        <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293-1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
                      </svg>
                    </div>
                    <div>
                      <p className="text-xs text-red-700">{error}</p>
                    </div>
                  </div>
                </div>
              ) : (
                <div>
                  {/* ูุงุฑุช ูุคุดุฑุงุช ุงูุฃุฏุงุก ุงูููุตูุฉ */}
                  <div className="bg-white rounded-lg shadow-sm overflow-hidden transition-shadow duration-300 hover:shadow-md mb-4">
                    <div className="px-4 py-2 border-b border-gray-200 bg-gradient-to-r from-indigo-500 to-purple-600">
                      <h2 className="text-base font-bold text-white text-center">ูุคุดุฑุงุช ุงูุฃุฏุงุก ุงูุชูุตูููุฉ</h2>
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 p-4">
                      {/* ุนุฑุถ ุชูุงุตูู ุงููุคุดุฑุงุช */}
                      {kpiDefinitions.map((kpiDef) => (
                        <KpiDetailCard key={kpiDef.id} kpiDef={kpiDef} />
                      ))}
                    </div>
                    
                    <div className="px-4 py-1.5 bg-gray-50 border-t border-gray-200">
                      <div className="flex justify-between items-center">
                        <div className="text-[9px] text-gray-500">
                          ุชู ุงูุชุญุฏูุซ: {new Date().toLocaleDateString('ar-SA')}
                        </div>
                        <div className="flex space-x-1 space-x-reverse">
                          <div className="flex items-center ml-2">
                            <div className="w-2 h-2 rounded-full bg-[#0072C6] mr-1"></div>
                            <span className="text-[9px] text-gray-600">ููุชุงุฒ</span>
                          </div>
                          <div className="flex items-center ml-2">
                            <div className="w-2 h-2 rounded-full bg-[#00B050] mr-1"></div>
                            <span className="text-[9px] text-gray-600">ุฌูุฏ</span>
                          </div>
                          <div className="flex items-center ml-2">
                            <div className="w-2 h-2 rounded-full bg-[#FFC000] mr-1"></div>
                            <span className="text-[9px] text-gray-600">ูุญุชุงุฌ ุชุญุณูู</span>
                          </div>
                          <div className="flex items-center">
                            <div className="w-2 h-2 rounded-full bg-[#C00000] mr-1"></div>
                            <span className="text-[9px] text-gray-600">ุบูุฑ ููุจูู</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  {/* ูุณู ุงูุฑุณูู ุงูุจูุงููุฉ ูุงูููุงุฑูุงุช */}
                  <div className="mt-6">
                    <h2 className="text-lg font-bold text-gray-800 mb-4">ุชุญููู ุงูุจูุงูุงุช ูุงูููุงุฑูุงุช</h2>
                    
                    {chartsLoading ? (
                      <div className="flex flex-col justify-center items-center h-40 bg-white rounded-lg shadow-sm">
                        <div className="w-10 h-10 border-3 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
                        <p className="text-sm text-gray-600 mt-2">ุฌุงุฑู ุชุญููู ุงูุฑุณูู ุงูุจูุงููุฉ...</p>
                      </div>
                    ) : (
                      <>
                        {/* ุงููุคุดุฑุงุช ุงูุฑุฆูุณูุฉ ุนุจุฑ ุงูุฒูู */}
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                          {/* ุฑุณู ุจูุงูู ูููุช ุงูุงูุชุธุงุฑ ูููููููู */}
                          <div className="bg-white rounded-lg shadow-sm p-4 hover:shadow-md transition-shadow duration-300">
                            {timeSeriesData.inpatientWaitTime.data.length > 0 ? (
                              <>
                                <TimeComparisonChart 
                                  data={timeSeriesData.inpatientWaitTime.data}
                                  labels={timeSeriesData.inpatientWaitTime.labels}
                                  title="ุฒูู ุงูุชุธุงุฑ ุงููููููู ุนุจุฑ ุงูุฒูู"
                                  label="ูุชูุณุท ุงูุณุงุนุงุช"
                                  backgroundColor="rgba(54, 162, 235, 0.2)"
                                  borderColor="rgba(54, 162, 235, 1)"
                                  benchmark={24} // ุงููููุฉ ุงููุณุชูุฏูุฉ (24 ุณุงุนุฉ)
                                  height={250}
                                  isTime={true}
                                  yAxisLabel="ุงูููุช (ุณุงุนุงุช)"
                                  direction="rtl"
                                />
                                <div className="mt-2 text-center">
                                  <div className="grid grid-cols-3 gap-2 mt-2">
                                    <div className="bg-gray-50 p-2 rounded-md">
                                      <p className="text-xs text-gray-500">ูุชูุณุท ููุช ุงูุงูุชุธุงุฑ</p>
                                      <p className="text-base font-bold text-indigo-600">
                                        {timeSeriesData.inpatientWaitTime.metadata.avg !== undefined ? 
                                          `${Math.round(timeSeriesData.inpatientWaitTime.metadata.avg / 60)} ุณุงุนุฉ` : 
                                          '-'}
                                      </p>
                                    </div>
                                    <div className="bg-gray-50 p-2 rounded-md">
                                      <p className="text-xs text-gray-500">ุฃูู ููุช ุงูุชุธุงุฑ</p>
                                      <p className="text-base font-bold text-green-600">
                                        {timeSeriesData.inpatientWaitTime.metadata.min !== undefined ? 
                                          `${Math.round(timeSeriesData.inpatientWaitTime.metadata.min / 60)} ุณุงุนุฉ` : 
                                          '-'}
                                      </p>
                                    </div>
                                    <div className="bg-gray-50 p-2 rounded-md">
                                      <p className="text-xs text-gray-500">ุฃุนูู ููุช ุงูุชุธุงุฑ</p>
                                      <p className="text-base font-bold text-red-600">
                                        {timeSeriesData.inpatientWaitTime.metadata.max !== undefined ? 
                                          `${Math.round(timeSeriesData.inpatientWaitTime.metadata.max / 60)} ุณุงุนุฉ` : 
                                          '-'}
                                      </p>
                                    </div>
                                  </div>
                                </div>
                              </>
                            ) : (
                              <div className="flex flex-col justify-center items-center h-64">
                                <svg className="w-12 h-12 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <p className="mt-2 text-sm text-gray-500">ูุง ุชูุฌุฏ ุจูุงูุงุช ูุงููุฉ ููุนุฑุถ</p>
                              </div>
                            )}
                          </div>
                          
                          {/* ุฑุณู ุจูุงูู ูููุช ุงูุชุธุงุฑ ุงูุนูุงุฏุงุช */}
                          <div className="bg-white rounded-lg shadow-sm p-4 hover:shadow-md transition-shadow duration-300">
                            {timeSeriesData.opdWaitTime.data.length > 0 ? (
                              <>
                                <TimeComparisonChart 
                                  data={timeSeriesData.opdWaitTime.data}
                                  labels={timeSeriesData.opdWaitTime.labels}
                                  title="ุฒูู ุงูุชุธุงุฑ ุงูุนูุงุฏุงุช ุนุจุฑ ุงูุฒูู"
                                  label="ูุชูุณุท ุงูุณุงุนุงุช"
                                  backgroundColor="rgba(153, 102, 255, 0.2)"
                                  borderColor="rgba(153, 102, 255, 1)"
                                  benchmark={24} // ุงููููุฉ ุงููุณุชูุฏูุฉ (24 ุณุงุนุฉ)
                                  height={250}
                                  isTime={true}
                                  yAxisLabel="ุงูููุช (ุณุงุนุงุช)"
                                  direction="rtl"
                                />
                                <div className="mt-2 text-center">
                                  <div className="grid grid-cols-3 gap-2 mt-2">
                                    <div className="bg-gray-50 p-2 rounded-md">
                                      <p className="text-xs text-gray-500">ูุชูุณุท ููุช ุงูุงูุชุธุงุฑ</p>
                                      <p className="text-base font-bold text-indigo-600">
                                        {timeSeriesData.opdWaitTime.metadata.avg !== undefined ? 
                                          `${Math.round(timeSeriesData.opdWaitTime.metadata.avg / 60)} ุณุงุนุฉ` : 
                                          '-'}
                                      </p>
                                    </div>
                                    <div className="bg-gray-50 p-2 rounded-md">
                                      <p className="text-xs text-gray-500">ุฃูู ููุช ุงูุชุธุงุฑ</p>
                                      <p className="text-base font-bold text-green-600">
                                        {timeSeriesData.opdWaitTime.metadata.min !== undefined ? 
                                          `${Math.round(timeSeriesData.opdWaitTime.metadata.min / 60)} ุณุงุนุฉ` : 
                                          '-'}
                                      </p>
                                    </div>
                                    <div className="bg-gray-50 p-2 rounded-md">
                                      <p className="text-xs text-gray-500">ุฃุนูู ููุช ุงูุชุธุงุฑ</p>
                                      <p className="text-base font-bold text-red-600">
                                        {timeSeriesData.opdWaitTime.metadata.max !== undefined ? 
                                          `${Math.round(timeSeriesData.opdWaitTime.metadata.max / 60)} ุณุงุนุฉ` : 
                                          '-'}
                                      </p>
                                    </div>
                                  </div>
                                </div>
                              </>
                            ) : (
                              <div className="flex flex-col justify-center items-center h-64">
                                <svg className="w-12 h-12 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <p className="mt-2 text-sm text-gray-500">ูุง ุชูุฌุฏ ุจูุงูุงุช ูุงููุฉ ููุนุฑุถ</p>
                              </div>
                            )}
                          </div>
                          
                          {/* ุฑุณู ุจูุงูู ููุนุฏู ุงุณุชุฎุฏุงู ุงูุฃุฌูุฒุฉ */}
                          <div className="bg-white rounded-lg shadow-sm p-4 hover:shadow-md transition-shadow duration-300">
                            {timeSeriesData.machineUtilization.data.length > 0 ? (
                              <>
                                <TimeComparisonChart 
                                  data={timeSeriesData.machineUtilization.data}
                                  labels={timeSeriesData.machineUtilization.labels}
                                  title="ูุนุฏู ุงุณุชุฎุฏุงู ุฃุฌูุฒุฉ CT ุนุจุฑ ุงูุฒูู"
                                  label="ูุนุฏู ุงูุงุณุชุฎุฏุงู"
                                  backgroundColor="rgba(75, 192, 192, 0.2)"
                                  borderColor="rgba(75, 192, 192, 1)"
                                  benchmark={80} // ุงููููุฉ ุงููุณุชูุฏูุฉ (80%)
                                  height={250}
                                  isPercentage={true}
                                  yAxisMin={0}
                                  yAxisMax={100}
                                  yAxisLabel="ุงููุณุจุฉ ุงููุฆููุฉ"
                                  direction="rtl"
                                />
                                <div className="mt-2 text-center">
                                  <div className="grid grid-cols-3 gap-2 mt-2">
                                    <div className="bg-gray-50 p-2 rounded-md">
                                      <p className="text-xs text-gray-500">ูุชูุณุท ูุนุฏู ุงูุงุณุชุฎุฏุงู</p>
                                      <p className="text-base font-bold text-indigo-600">
                                        {timeSeriesData.machineUtilization.metadata.avg !== undefined ? 
                                          `${Math.round(timeSeriesData.machineUtilization.metadata.avg)}%` : 
                                          '-'}
                                      </p>
                                    </div>
                                    <div className="bg-gray-50 p-2 rounded-md">
                                      <p className="text-xs text-gray-500">ุฃูู ูุนุฏู</p>
                                      <p className="text-base font-bold text-red-600">
                                        {timeSeriesData.machineUtilization.metadata.min !== undefined ? 
                                          `${Math.round(timeSeriesData.machineUtilization.metadata.min)}%` : 
                                          '-'}
                                      </p>
                                    </div>
                                    <div className="bg-gray-50 p-2 rounded-md">
                                      <p className="text-xs text-gray-500">ุฃุนูู ูุนุฏู</p>
                                      <p className="text-base font-bold text-green-600">
                                        {timeSeriesData.machineUtilization.metadata.max !== undefined ? 
                                          `${Math.round(timeSeriesData.machineUtilization.metadata.max)}%` : 
                                          '-'}
                                      </p>
                                    </div>
                                  </div>
                                </div>
                              </>
                            ) : (
                              <div className="flex flex-col justify-center items-center h-64">
                                <svg className="w-12 h-12 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <p className="mt-2 text-sm text-gray-500">ูุง ุชูุฌุฏ ุจูุงูุงุช ูุงููุฉ ููุนุฑุถ</p>
                              </div>
                            )}
                          </div>
                          
                          {/* ุฑุณู ุจูุงูู ูุฅุฌูุงูู ุงููุฑุถู - ุงูุชุฑุงุถู */}
                          <div className="bg-white rounded-lg shadow-sm p-4 hover:shadow-md transition-shadow duration-300">
                            <div className="flex flex-col justify-center items-center h-64">
                              <svg className="w-12 h-12 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                              </svg>
                              <p className="mt-2 text-sm text-gray-500">ุจูุงูุงุช ุฅุฌูุงูู ุงููุฑุถู ุบูุฑ ูุชููุฑุฉ ุญุงููุงู</p>
                            </div>
                          </div>
                        </div>
                        
                        {/* ุฑุณูู ุจูุงููุฉ ููููุงุฑูุงุช */}
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                          {/* ูุนุฏูุงุช ุงุณุชุฎุฏุงู ุงูุฃุฌูุฒุฉ */}
                          <div className="bg-white rounded-lg shadow-sm p-4 hover:shadow-md transition-shadow duration-300">
                            {comparativeData.machineUtilization.data.length > 0 ? (
                              <>
                                <ComparativeBarChart 
                                  data={comparativeData.machineUtilization.data}
                                  labels={comparativeData.machineUtilization.labels}
                                  title="ููุงุฑูุฉ ูุนุฏูุงุช ุงุณุชุฎุฏุงู ุงูุฃุฌูุฒุฉ"
                                  label="ูุณุจุฉ ุงูุงุณุชุฎุฏุงู"
                                  colors={[
                                    'rgba(75, 192, 192, 0.7)',
                                    'rgba(153, 102, 255, 0.7)',
                                    'rgba(255, 159, 64, 0.7)'
                                  ]}
                                  height={300}
                                  direction="rtl"
                                />
                                <div className="mt-2 text-center">
                                  <p className="text-xs text-gray-500">
                                    ุงููุฏู ุงูุฃูุซู: ุฃูุซุฑ ูู 80% ูุฌููุน ุงูุฃุฌูุฒุฉ
                                  </p>
                                </div>
                              </>
                            ) : (
                              <div className="flex flex-col justify-center items-center h-64">
                                <svg className="w-12 h-12 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <p className="mt-2 text-sm text-gray-500">ูุง ุชูุฌุฏ ุจูุงูุงุช ูุงููุฉ ููุนุฑุถ</p>
                              </div>
                            )}
                          </div>
                          
                          {/* ุชูุฒูุน ุฃููุงุน ุงููุญูุตุงุช */}
                          <div className="bg-white rounded-lg shadow-sm p-4 hover:shadow-md transition-shadow duration-300">
                            {comparativeData.scansByType.data.length > 0 ? (
                              <>
                                <ComparativeBarChart 
                                  data={comparativeData.scansByType.data}
                                  labels={comparativeData.scansByType.labels}
                                  title="ุชูุฒูุน ุฃููุงุน ุงููุญูุตุงุช"
                                  label="ุงููุณุจุฉ ุงููุฆููุฉ"
                                  colors={[
                                    'rgba(54, 162, 235, 0.7)',
                                    'rgba(75, 192, 192, 0.7)',
                                    'rgba(153, 102, 255, 0.7)',
                                    'rgba(255, 159, 64, 0.7)',
                                    'rgba(255, 99, 132, 0.7)'
                                  ]}
                                  height={300}
                                  direction="rtl"
                                />
                                <div className="mt-2 text-center">
                                  <p className="text-xs text-gray-500">
                                    ุฅุฌูุงูู ุงููุญูุตุงุช: {comparativeData.scansByType.data.reduce((a, b) => a + b, 0)}
                                  </p>
                                </div>
                              </>
                            ) : (
                              <div className="flex flex-col justify-center items-center h-64">
                                <svg className="w-12 h-12 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <p className="mt-2 text-sm text-gray-500">ูุง ุชูุฌุฏ ุจูุงูุงุช ูุงููุฉ ููุนุฑุถ</p>
                              </div>
                            )}
                          </div>
                        </div>
                      </>
                    )}
                  </div>
                </div>
              )}
              
              {/* ุญููู ุงูููููุฉ */}
              <div className="mt-4 text-center text-xs text-gray-500">
                <p>ยฉ {new Date().getFullYear()} ูุณู ุงูุฃุดุนุฉ - ูุณุชุดูู ุดุฑู ุฌุฏุฉ - ุฌููุน ุงูุญููู ูุญููุธุฉ</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default RAD;